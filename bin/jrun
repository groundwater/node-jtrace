#!/usr/bin/env node

var fs     = require('fs');
var http   = require('http');
var util   = require('util');
var vm     = require('vm');
var solid  = require('lib-stream-solidify');
var jtrace = require('../index.js');

var server = http.createServer(function (req, res) {

  // intercept console.log statements and send to client
  var write = function () {
    res.write(util.format.apply(null, arguments) + '\n');
  };

  solid(req).text(function (err, src) {
    var module  = {
      exports: {},
      console: {
        log   : write,
        dir   : write,
        info  : write,
        warn  : write,
        error : write,
      },
    };
    module.module = module;
    var context = vm.createContext(module);
    vm.runInContext(src, context);

    // set handler
    jtrace.jtrace.on(null, context.exports);

  });

  // disengage tracing when client disconnects
  req.on('close', function () {
    jtrace.jtrace.enabled  = false;
    jtrace.jtrace.handlers = []; // reset handlers
  });
});

if (fs.existsSync('.jtrace.sock')) fs.unlinkSync('.jtrace.sock')
server.listen('.jtrace.sock');

require(process.cwd() + '/' + process.argv[2])
