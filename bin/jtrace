#!/usr/bin/env node

var argv = require('minimist')(process.argv.slice(2));
var http = require('http');
var url  = require('url');
var tty  = require('tty');

if (tty.isatty(process.stdin))
  throw 'need a script on STDIN';

var level = parseInt(argv.level || 10, 10)

if (argv.fatal) level =  50;
if (argv.error) level =  30;
if (argv.warn)  level =  20;
if (argv.info)  level =  10;
if (argv.log)   level =   0;
if (argv.debug) level = -10;
if (argv.trace) level = -50;

if (!argv.p) argv.p = [];
if (!Array.isArray(argv.p)) argv.p = [argv.p];

var providers = argv.p.join(',');
var path = url.format({
  pathname: '/',
  query: {
    level: level,
    providers: providers,
  },
});

var req = http.request({
  socketPath: '.jtrace.sock',
  headers: {
    'Transfer-Encoding': 'chunked'
  },
  path: path,
}, function(res){
  res.pipe(process.stdout);
});

process.stdin.pipe(req);
